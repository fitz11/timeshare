rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Calendar rules - protect calendar access and modifications
    match /calendars/{calendarId} {
      // Helper: Check if authenticated user is the calendar owner
      function isOwner() {
        return request.auth != null && resource.data.owner == request.auth.uid;
      }

      // Helper: Check if authenticated user is in the sharedWith list
      function isSharedWith() {
        return request.auth != null && request.auth.uid in resource.data.sharedWith;
      }

      // Helper: Verify sharedWith field wasn't modified (for non-owner updates)
      function sharedWithUnchanged() {
        return request.resource.data.sharedWith == resource.data.sharedWith;
      }

      // Read: Only owner or users in sharedWith list
      allow read: if isOwner() || isSharedWith();

      // Create: Only if owner field matches the authenticated user
      allow create: if request.auth != null && request.resource.data.owner == request.auth.uid;

      // Update: Owner can update anything; shared users can update but NOT the sharedWith field
      allow update: if isOwner() || (isSharedWith() && sharedWithUnchanged());

      // Delete: Only the owner can delete
      allow delete: if isOwner();

      // Events subcollection rules
      match /events/{eventId} {
        // Helper: Get parent calendar data
        function getCalendar() {
          return get(/databases/$(database)/documents/calendars/$(calendarId)).data;
        }

        // Helper: Check if user is the calendar owner
        function isCalendarOwner() {
          return request.auth != null && request.auth.uid == getCalendar().owner;
        }

        // Helper: Check if user is in the calendar's sharedWith list
        function isCalendarShared() {
          return request.auth != null && request.auth.uid in getCalendar().sharedWith;
        }

        // Read: Owner or shared users can read events
        allow read: if isCalendarOwner() || isCalendarShared();

        // Create/Update/Delete: Owner or shared users can modify events
        allow create, update, delete: if isCalendarOwner() || isCalendarShared();
      }
    }

    // User rules - users can read any profile but only write their own
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
